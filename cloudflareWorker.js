let cookies = [
    {
        "domain": ".bing.com",
        "expirationDate": 1713613457.051363,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SnrOvr",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "X=rebateson"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1716551057.966786,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SRCHUSR",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "DOB=20230326&T=1681991049000&POEX=W"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1682034254.846415,
        "hostOnly": false,
        "httpOnly": true,
        "name": "SUID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "A"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1716551060.138305,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SRCHHPGUSR",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "SRCHLANG=zh-Hans&DM=1&THEME=1&WTS=63817587849&PV=10.0.0&BZA=1&BRW=XW&BRH=M&CW=1902&CH=908&SCW=1797&SCH=4055&DPR=1.0&UTC=480&EXLTT=8&HV=1681991056&PRVCW=1902&PRVCH=908"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1697802257.954966,
        "hostOnly": false,
        "httpOnly": false,
        "name": "ANON",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "A=87C577E2C80F4E4B3430E71DFFFFFFFF&E=1c24&W=1"
    },
    {
        "domain": ".bing.com",
        "hostOnly": false,
        "httpOnly": false,
        "name": "_SS",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": null,
        "value": "SID=16C1EE7EA33F690A0B40FC87A25968A3&R=669&RB=669&GB=0&RG=0&RP=573"
    },
    {
        "domain": ".bing.com",
        "hostOnly": false,
        "httpOnly": false,
        "name": "ipv6",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": null,
        "value": "hit=1681994659910&t=4"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1683200657.95521,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_U",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "1OeBEXSrZTqw0weYAD1c0XeeJT7UUo4KB4vIVJSJFeWJ-WogXHvb8fsOT5NA1TXodyKT9Nh2GPosdyZLFKBhLxMadb_7Ckln-B2FWTW9X43hacrgVddGgMCXkYOX6NS_iTV2G-f1O0tcuVyyqUFOrCKX3kknY12VSiOAE1YSsx4d0ceRROu8dYGohhSsjmzbw28HO9uEfprgxsEnBGJym5Q"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1714394184.650113,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SRCHD",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AF=SHORUN"
    },
    {
        "domain": ".bing.com",
        "hostOnly": false,
        "httpOnly": false,
        "name": "PPLState",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": null,
        "value": "1"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1682434836,
        "hostOnly": false,
        "httpOnly": false,
        "name": "ANIMIA",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "FRE=1"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1713530184.650033,
        "hostOnly": false,
        "httpOnly": true,
        "name": "_EDGE_V",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "1"
    },
    {
        "domain": ".bing.com",
        "hostOnly": false,
        "httpOnly": false,
        "name": "NAP",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": null,
        "value": "V=1.9&E=1bca&C=wyY6vUL1SYJ-CjEieMVQi3mCDJas2ZBH0-j0Mvm3Ff0AmV8O0G67MQ&W=1"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1716551058.408092,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_RwBf",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "ilt=1&ihpd=0&ispd=1&rc=669&rb=669&gb=0&rg=0&pc=573&mtu=0&rbb=0.0&g=0&cid=&clo=0&v=1&l=2023-04-20T07:00:00.0000000Z&lft=0001-01-01T00:00:00.0000000&aof=0&o=0&p=bingcopilotwaitlist&c=MY00IA&t=2799&s=2023-02-26T05:03:18.1075639+00:00&ts=2023-04-20T11:44:11.0843168+00:00&rwred=0&wls=2&lka=0&lkt=0&TH=&W=1&r=1&mta=0&e=42kinu7ml6oX60m3NdebRBePgaG4e7jIqbc0FhyXme3vdtfnss-J_QdcWpP7z24DAYYpyxSUn4D8RJxcZyIf-j1oiSrIu_zAXpjWYPUQXdY&A=87C577E2C80F4E4B3430E71DFFFFFFFF&mte=0"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1714916363.400597,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_UR",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "QS=0&TQS=0"
    },
    {
        "domain": ".bing.com",
        "hostOnly": false,
        "httpOnly": true,
        "name": "_EDGE_S",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": true,
        "storeId": null,
        "value": "SID=16C1EE7EA33F690A0B40FC87A25968A3"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1716551055.822215,
        "hostOnly": false,
        "httpOnly": true,
        "name": "USRLOC",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "HS=1&ELOC=LAT=30.821300506591797|LON=111.79476165771484|N=%E5%BD%93%E9%98%B3%E5%B8%82%EF%BC%8C%E6%B9%96%E5%8C%97%E7%9C%81|ELT=6|"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1714916363.625947,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_HPVN",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "CS=eyJQbiI6eyJDbiI6MSwiU3QiOjAsIlFzIjowLCJQcm9kIjoiUCJ9LCJTYyI6eyJDbiI6MSwiU3QiOjAsIlFzIjowLCJQcm9kIjoiSCJ9LCJReiI6eyJDbiI6MSwiU3QiOjAsIlFzIjowLCJQcm9kIjoiVCJ9LCJBcCI6dHJ1ZSwiTXV0ZSI6dHJ1ZSwiTGFkIjoiMjAyMy0wNC0wMVQwMDowMDowMFoiLCJJb3RkIjowLCJHd2IiOjAsIkRmdCI6bnVsbCwiTXZzIjowLCJGbHQiOjAsIkltcCI6Mn0="
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1716551055.618073,
        "hostOnly": false,
        "httpOnly": false,
        "name": "ABDEF",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "V=13&ABDV=11&MRNB=1681991055620&MRB=0"
    },
    {
        "domain": ".bing.com",
        "hostOnly": false,
        "httpOnly": true,
        "name": "KievRPSSecAuth",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": null,
        "value": "FABSBBRaTOJILtFsMkpLVWSG6AN6C/svRwNmAAAEgAAACPnK6dMgIaZWEAQ0gVUxT9g7EfFthwQCa03YxGyRK638O7Htm+SgJIVMGPDkE+f+g9OxRAz04CyoeWuOWYsq1xJis9SiBJUiLLJuw3aQOIKsIslzV38eeFc6EYvWpzH//JQIajm8UIaMlIjmNmww2n5YJ0kmsR9dYF0M2QqjexZlZMPuWmzmFaQgV3V4w9nKJXHSUyeFBgwsJ5t78DZIm6qWLi+9BPWTCiGuxe/WCirrJqgoUCuOuYOsc5FJ5MggfODgixIch61L1Gt8IbvMhPp8pa11HwhEC4kH34MA/6gVhIBR/jGnIpsUWS5z9rtRppA2TGfNV2vFDMDgf3aIdIiN4B8dFFrA2bG5/b1ZiiM2/Flji0RffMFbazxyVPR7th1FkwBRltHvNlplOFHFnrf/osPpU/k45UxfoWRG39WG1Ap4VR4me612+aoby/pVZvNMl7wxRTX/oZsQpenTvypFbVxcb0516NdA4b2J4lG48o7F9pHEMaliwLu0h17oEraAEL3hrHaq5vyGf7wY3q7wzDoy+PxCwB+Qe7j13S8X9mE2kdTm7M3jiNwBz39XtoEcHZuIfyNl9SbSJE3jBPxjXUvAWlWj0I5wA3eQZFF3rVes9SKqEQZXfUvQo6uhlx9N4LUqTkG4g6mXnIk6KZw8xfbIkxuDybwnvu7uIs3vXYqhxv7szPokF89bIV04x0fWcjfYvg8ZIYmWKD7+5v39QkrqrytEoqID+UBLXN2M0noqC2OgUOSlpG8g4H0lRlS2zRBCs9RIB3OXEakPoB6Nv2xK/ErkmZMYahwg4RqVrsr/l0MzF96RvbOpwTUoaxeQKtpJnUalVAK4Gulzh80ACM+rVnmGTvV51oXaDZcYvufZGNZ4West4Baw7n54+14VnGJeRjeI7gMaeHydHQ41xaSx/Rhm0w0YvL+nYIpZtgAnviPaiVIbzkYQX2pJTQduUbDHZ8+nsiZgNL7xrk+bWu7WpfkonlHmO1EUILuZz1pL1MB+BcD63kQzMMzF7kXNY0LmceNDQxnwTs7ThpUMozQkbLzwcIXCDJ/PJRE8A1pGOvUhcQZ6TBoHBgLtUWSU4S4DNTdFdQ1dYcQYm3n5GosLI41S04LJDaCXS3f/2tH62kZiUJseb0JoYKatKGK3xadrLbDkAh0hUu5lhJdnbxRihaYBE3T+vF7KdfhYuOnoGbmNkZ2h3uVHovgeSNbo106/aVLSXVoXlfLz+j10aSL2FM7cTDNFZhVOS3CqpxqWmQkkXrCvfIDGX7ix8uFJ7fhrNDrKJzFLaevDHQ2vFVVneMtSrlIeBfDrdXu0ptFkuJueLzrxciC7Isn2JC5qqPW/ErHk0Dpih/mWLCd1ueaDpEfNLGKE6EI3f6BaPrRMn0fOHYk6khQAZTz5mn2Ch7n+sMPXIfGhwiusm6c="
    },
    {
        "domain": "cn.bing.com",
        "expirationDate": 1711892364.485252,
        "hostOnly": true,
        "httpOnly": false,
        "name": "MicrosoftApplicationsTelemetryDeviceId",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "ec4690d2-a2fb-4624-b058-f1fe22b27f99"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1714833305.814916,
        "hostOnly": false,
        "httpOnly": false,
        "name": "MUID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "1B795C5952C16FA913574EB953EF6E65"
    },
    {
        "domain": "cn.bing.com",
        "expirationDate": 1715687061.116917,
        "hostOnly": true,
        "httpOnly": true,
        "name": "MUIDB",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "1B795C5952C16FA913574EB953EF6E65"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1716551055.608681,
        "hostOnly": false,
        "httpOnly": false,
        "name": "MUIDV",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "NU=1"
    },
    {
        "domain": ".bing.com",
        "hostOnly": false,
        "httpOnly": false,
        "name": "SNRHOP",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": null,
        "value": "I=&TS="
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1714394184.650142,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SRCHUID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "V=2&GUID=00505E6D10EC4A3AA3BE5921B10B1687&dmnchg=1"
    },
    {
        "domain": ".bing.com",
        "expirationDate": 1683200658.407943,
        "hostOnly": false,
        "httpOnly": true,
        "name": "WLID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "Ktr6VlPrDtNwwth9hpZGZaLOD2QhsZ4c1YpE+SJJehxHv7AxatSQJoKPsFoVjUDlS1SGed+8E0J7o+Rm+76ovl9KEoEcqzB/xJhwh1W6yYg="
    },
    {
        "domain": ".bing.com",
        "hostOnly": false,
        "httpOnly": false,
        "name": "WLS",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": null,
        "value": "C=3516be824033f7a0&N=qh"
    }
    
]

export default {
    async fetch(request, _env) {
        return await handleRequest(request);
    }
}

/**
 * Respond to the request
 * @param {Request} request
 */
let startReg = new RegExp("^(https?://)([-a-zA-z0-9]+\\.)+([-a-zA-z0-9]+)+");
async function handleRequest(request) {
    if (isEquals(request, "/sydney/ChatHub")) { //魔法聊天
        return bingChatHub(request)
    }
    if (isEquals(request, "/turing/conversation/create")) { //创建聊天
        return goUrl(request, "https://www.bing.com/turing/conversation/create");
    }
    if (isEquals(request, "/msrewards/api/v1/enroll\\?(.*)")) { //加入候补
        let a = request.url.split("?");
        return goUrl(request, "https://www.bing.com/msrewards/api/v1/enroll?" + a[1]);
    }
    if (isEquals(request, "/images/create\\?(.*)")) { //AI画图
        let a = request.url.split("?");
        return goUrl(request, "https://www.bing.com/images/create?" + a[1], {
            "sec-fetch-site": "same-origin",
            "referer": "https://www.bing.com/search?q=bingAI"
        });
    }
    if (isEquals(request, "/images/create/async/results(.*)")) { //请求AI画图图片
        let reg = new RegExp("^(https?://)([-a-zA-z0-9]+\\.)+([-a-zA-z0-9]+)+(/images/create/async/results)");
        let a = request.url.replace(reg, "https://www.bing.com/images/create/async/results");
        return goUrl(request, a, {
            "sec-fetch-site": "same-origin",
            "referer": "https://www.bing.com/images/create?partner=sydney&showselective=1&sude=1&kseed=7000"
        });
    }
    //用于测试
    if (isEquals(request, "/test/(.*)")) {
        let reg = new RegExp(`^(https?://)([-a-zA-z0-9]+\\.)+([-a-zA-z0-9]+)+(${"/test/(.*)"})$`);
        let a = request.url.replace(reg, "$5");
        return goUrl(request, a);
    }
    if (isEquals(request, "/web/(.*)")||isEquals(request, "/favicon.ico")) { //web请求
        let reg = new RegExp("^(https?://)([-a-zA-z0-9]+\\.)+([-a-zA-z0-9]+)+(/)");
        let a = request.url.replace(reg, "https://raw.githubusercontent.com/jianjianai/NewBingGoGo-Web/master/src/main/resources/");
        return await goWeb(a);
    }
    return getRedirect('/web/NewBingGoGo.html');
}

//匹配url
function isEquals(request, path) {
    let reg = new RegExp(`^(https?://)([-a-zA-z0-9]+\\.)+([-a-zA-z0-9]+)+(${path})$`);
    return reg.test(request.url);
}

async function goWeb(path) {
    let res = await fetch(path);
    let mimeType;
    if (path.endsWith(".html")) {
        mimeType = "text/html; charset=utf-8";
    } else if (path.endsWith(".js")) {
        mimeType = "application/x-javascript; charset=utf-8";
    } else if (path.endsWith(".css")) {
        mimeType = "text/css; charset=utf-8";
    } else if (path.endsWith(".png")) {
        mimeType = "image/png";
    } else if (path.endsWith(".ico")) {
        mimeType = "image/png";
    }
    return new Response(res.body, {
        status: 200,
        statusText: 'ok',
        headers: {
            "content-type": mimeType
        }
    });
}

//请求某地址
async function goUrl(request, url, addHeaders) {
    //构建 fetch 参数
    let fp = {
        method: request.method,
        headers: {}
    }
    //保留头部信息
    let reqHeaders = new Headers(request.headers);
    let dropHeaders = ["user-agent", "accept", "accept-language"];
    let he = reqHeaders.entries();
    for (let h of he) {
        let key = h[0],
            value = h[1];
        if (dropHeaders.includes(key)) {
            fp.headers[key] = value;
        }
    }
    if (addHeaders) {
        //添加头部信息
        for (let h in addHeaders) {
            fp.headers[h] = addHeaders[h];
        }
    }

    //添加配置的随机cookie
    if (cookies.length == 0) {
        return getReturnError("没有任何可用cookie，请前在第一行代码cookies变量中添加cookie");
    }
    let cookieID =0;
    if(reqHeaders.get('NewBingGoGoWeb')){//如果是web版
        cookieID = Math.floor(Math.random() * cookies.length);
        let userCookieID = reqHeaders.get("cookieID");
        if (userCookieID) {
            if (userCookieID >= 0 && userCookieID < cookies.length) {
                cookieID = userCookieID;
            } else {
                return getReturnError("cookieID不存在，请刷新页面测试！");
            }
        }
        fp.headers["cookie"] = cookies[cookieID];
    }else {//如果是插件版
        fp.headers["cookie"] = reqHeaders.get('cookie');
    }

    //添加X-forwarded-for
    fp.headers['X-forwarded-for'] = `${getRndInteger(3,5)}.${getRndInteger(1,255)}.${getRndInteger(1,255)}.${getRndInteger(1,255)}`;

    let res = await fetch(url, fp);
    let headers = new Headers(res.headers);
    headers.set("cookieID",cookieID);
    return new Response(res.body,{
        status:res.status,
        statusText:res.statusText,
        headers:headers
    });
}

//随机数生成
function getRndInteger(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
}

//获取用于返回的错误信息
function getReturnError(error) {
    return new Response(JSON.stringify({
        result: {
            value: 'error',
            message: error
        }
    }), {
        status: 200,
        statusText: 'ok',
        headers: {
            "content-type": "application/json"//,
            //"Access-Control-Allow-Origin": "*"
        }
    })
}

//返回重定向
function getRedirect(url) {
    return new Response("正在重定向到" + url, {
        status: 302,
        statusText: 'redirect',
        headers: {
            "content-type": "text/html",
            "location": url
        }
    })
}

//websocket
function bingChatHub(request) {
    // 如果请求包含 Upgrade 头，说明是 WebSocket 连接
    if (request.headers.get('Upgrade') === 'websocket') {
        const webSocketPair = new WebSocketPair()
        const serverWebSocket = webSocketPair[1]
        var bingws = new WebSocket('wss://sydney.bing.com/sydney/ChatHub')
        serverWebSocket.onmessage = event => {
            bingws.send(event.data);
        }
        bingws.onmessage = event => {
            serverWebSocket.send(event.data)
        }
        bingws.onopen = event => {
            serverWebSocket.accept();
        }
        bingws.onclose = event => {
            serverWebSocket.close(event.code, event.reason);
        }
        bingws.onerror = event => {
            serverWebSocket.send(JSON.stringify({
                type: 'error',
                mess: "workers接到bing错误：" + event
            }));
            serverWebSocket.close();
        }
        serverWebSocket.onerror = event => {
            serverWebSocket.close();
        }
        serverWebSocket.onclose = event => {
            bingws.close(event.code, event.reason);
        }

        return new Response(null, { status: 101, webSocket: webSocketPair[0] })
    } else {
        return new Response('这不是websocket请求！')
    }
}
